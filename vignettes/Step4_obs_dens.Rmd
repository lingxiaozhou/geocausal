---
title: "Step 4. Obtaining observed densities"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Step 4. Obtaining observed densities}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, include = FALSE}
library(geocausal)
```

```{r load data, include = FALSE}
# Vignette 1 -----

airstrikes <- geocausal::airstrikes
insurgencies <- geocausal::insurgencies
iraq_window <- geocausal::iraq_window

# 1. Treatment data

## 1-1. Convert time variable to numerics
airstrikes$time <- as.numeric(airstrikes$date - min(airstrikes$date) + 1)

## 1-2. Generate a hyperframe
treatment_hfr <- get_hfr(data = airstrikes,
                         subtype_column = "type",
                         window = iraq_window,
                         time_column = "time",
                         time_range = c(1, max(airstrikes$time)),
                         coordinates = c("longitude", "latitude"),
                         combined = TRUE)

# 2. Outcome data

## 2-1. Convert time variable to numerics
insurgencies$time <- as.numeric(insurgencies$date - min(insurgencies$date) + 1)

outcome_hfr <- get_hfr(data = insurgencies,
                       subtype_column = "type",
                       window = iraq_window,
                       time_column = "time",
                       time_range = c(1, max(insurgencies$time)),
                       coordinates = c("longitude", "latitude"),
                       combined = TRUE)

# 3. Combine two hyperframes
dat_hfr <- spatstat.geom::cbind.hyperframe(treatment_hfr, outcome_hfr[, -1])
names(dat_hfr)[names(dat_hfr) == "all_combined"] <- "all_treatment"
names(dat_hfr)[names(dat_hfr) == "all_combined.1"] <- "all_outcome"

# Vignette 2 -----

# Smoothing
smooth_allout <- get_smoothed_outcome(data_interest = dat_hfr$all_outcome,
                                      method = "mclust", initialization = TRUE,
                                      sampling = 0.05)

# Save the output
dat_hfr$smooth_allout <- smooth_allout

# Vignette 3 -----

# Distance from Baghdad
dist_baghdad <- get_dist_focus(window = iraq_window,
                               longitude = c(44.366), #Baghdad
                               latitude = c(33.315),
                               resolution = 0.02,
                               grayscale = FALSE,
                               mile = FALSE,
                               preprocess = FALSE)

dat_hfr$dist_bagh <- dist_baghdad$distance_im

time_interval <- 1:nrow(dat_hfr)

# Outcome history
hist_allout_1 <- lapply(time_interval, get_hist,
                        Xt = dat_hfr$all_outcome,
                        lag = 1, window = iraq_window)

dat_hfr$hist_allout_1 <- purrr::map(hist_allout_1, 1)

# Treatment history
hist_alltre_1 <- lapply(time_interval, get_hist,
                        Xt = dat_hfr$all_treatment,
                        lag = 1, window = iraq_window)

dat_hfr$hist_alltre_1 <- purrr::map(hist_alltre_1, 1)

# Smoothing
dat_hfr$hist_allout_1 <- get_smoothed_outcome(data_interest = dat_hfr$hist_allout_1,
                                              method = "mclust", initialization = TRUE,
                                              sampling = 0.05)

dat_hfr$hist_alltre_1 <- get_smoothed_outcome(data_interest = dat_hfr$hist_alltre_1,
                                              method = "mclust", initialization = TRUE,
                                              sampling = 0.05)

```

The observed densities of treatment events (in our example, airstrikes) will be used to estimate causal effects of hypothetical treatment scenarios. To obtain observed densities, we use `get_obs_dens()`. It fits an inhomogeneous Poisson model and obtain intensities by segmenting the area of interest into grid cells; obtains the estimated number of outcome events for each time period by integrating the intensities over the area of interest; and calculates the sum of log intensities of all observations for each time period. Since estimating intensities over the entire window is computationally demanding, we set `ngrid = 100`.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
# List of RHS variables
rhs_var <- c("dist_bagh", "hist_alltre_1", "hist_allout_1")

# Get observed density over the entire window, for the entire period
obs_density <- get_obs_dens(dat_hfr, "Airstrike", rhs_var, 
                            ngrid = 100, window = iraq_window)
```

We can then compare the estimated and actual count measures by plotting them. To do so, we use `vis_obs_dens()` function. It visualizes the actual and predicted counts of treatment events.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot_compare <- vis_obs_dens(actual_data = dat_hfr$Airstrike, 
                             dens_1 = obs_density, dens_2 = NA,
                             time_unit = "Days")

plot_compare$plot_compare +
  ggplot2::annotate("text", label = "Actual", 
                    x = 10, y = 40, size = 4, color = "darkgrey") +
  ggplot2::annotate("text", label = "Predicted", 
                    x = 70, y = 15, size = 4, color = "#D55E00")

plot_compare$plot_residual
```

# Out-of-sample prediction

With `predict_obs_dens()` function, users can also perform out-of-sample prediction. For example, users can use the first 80% of observations as a training set and fit the model as follows.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
obs_density_8 <- predict_obs_dens(dat_hfr, ratio = 0.8, "Airstrike", 
                                  rhs_var, ngrid = 100, iraq_window)

plot_out_of_sample <- vis_obs_dens(actual_data = dat_hfr$Airstrike, 
                                   dens_1 = obs_density, 
                                   dens_2 = obs_density_8,
                                   time_unit = "Days")

plot_out_of_sample$plot_compare +
  ggplot2::annotate("text", label = "Actual", 
                    x = 10, y = 40, size = 4, color = "darkgray") +
  ggplot2::annotate("text", label = "Predicted", 
                    x = 50, y = 20, size = 4, color = "#D55E00") +
  ggplot2::annotate("text", label = "Out-of-sample\n(80%)", 
                    x = 70, y = 15, size = 4, color = "#0072B2") +
  ggplot2::geom_vline(xintercept = obs_density_8$training_row_max, 
                      linetype = "dashed", color = "#0072B2")
```
