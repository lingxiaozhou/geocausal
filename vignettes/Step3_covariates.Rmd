---
title: "Step 3. Preparing covariates"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Step 3. Preparing covariates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, include = FALSE}
library(geocausal)
```

```{r load data, include = FALSE}
# Vignette 1 -----

airstrikes <- geocausal::airstrikes
insurgencies <- geocausal::insurgencies
iraq_window <- geocausal::iraq_window

# 1. Treatment data

## 1-1. Convert time variable to numerics
airstrikes$time <- as.numeric(airstrikes$date - min(airstrikes$date) + 1)

## 1-2. Generate a hyperframe
treatment_hfr <- get_hfr(data = airstrikes,
                         subtype_column = "type",
                         window = iraq_window,
                         time_column = "time",
                         time_range = c(1, max(airstrikes$time)),
                         coordinates = c("longitude", "latitude"),
                         combined = TRUE)

# 2. Outcome data

## 2-1. Convert time variable to numerics
insurgencies$time <- as.numeric(insurgencies$date - min(insurgencies$date) + 1)

outcome_hfr <- get_hfr(data = insurgencies,
                       subtype_column = "type",
                       window = iraq_window,
                       time_column = "time",
                       time_range = c(1, max(insurgencies$time)),
                       coordinates = c("longitude", "latitude"),
                       combined = TRUE)

# 3. Combine two hyperframes
dat_hfr <- spatstat.geom::cbind.hyperframe(treatment_hfr, outcome_hfr[, -1])
names(dat_hfr)[names(dat_hfr) == "all_combined"] <- "all_treatment"
names(dat_hfr)[names(dat_hfr) == "all_combined.1"] <- "all_outcome"

# Vignette 2 -----

# Smoothing
smooth_IED <- get_smoothed_outcome(data_interest = dat_hfr$IED,
                                   method = "mclust", initialization = TRUE,
                                   sampling = 0.05)

smooth_SAF <- get_smoothed_outcome(data_interest = dat_hfr$SAF,
                                   method = "mclust", initialization = TRUE,
                                   sampling = 0.05)

smooth_allout <- get_smoothed_outcome(data_interest = dat_hfr$all_outcome,
                                      method = "mclust", initialization = TRUE,
                                      sampling = 0.05)

# Save the output
dat_hfr$smooth_IED <- smooth_IED
dat_hfr$smooth_SAF <- smooth_SAF
dat_hfr$smooth_allout <- smooth_allout
```

To model the distribution of treatment events, it is essential to incorporate appropriate covariates. Covariates should be image or point process objects. Functions `get_dist_focus()`, `get_dist_line()`, and `get_elevation()` help users calculate distances from points, distances from lines or polygons, and height above sea level, respectively. As an illustration, the usage of `get_dist_focus()` can be found below.

```{r}
# Distance from Baghdad
dist_baghdad <- get_dist_focus(window = iraq_window,
                               longitude = c(44.366), #Baghdad
                               latitude = c(33.315),
                               resolution = 0.02,
                               grayscale = FALSE,
                               mile = FALSE,
                               preprocess = FALSE)

dat_hfr$dist_bagh <- dist_baghdad$distance_im
```

# Treatment and outcome histories as covariates

In this example, we also employ histories of treatment and outcome events as covariates. To obtain histories of treatment and outcome events, `get_hist()` and `get_smoothed_outcome()` are used. To illustrate this process, sample code to obtain one-day histories of treatment and outcome events is shown below.

```{r}
time_interval <- 1:nrow(dat_hfr)

# Outcome history
hist_allout_1 <- lapply(time_interval, get_hist,
                        Xt = dat_hfr$all_outcome,
                        lag = 1, window = iraq_window)

dat_hfr$hist_allout_1 <- purrr::map(hist_allout_2, 1)

# Treatment history
hist_alltre_1 <- lapply(time_interval, get_hist,
                        Xt = dat_hfr$all_treatment,
                        lag = 1, window = iraq_window)

dat_hfr$hist_alltre_1 <- purrr::map(hist_alltre_1, 1)

# Smoothing
dat_hfr$hist_allout_1 <- get_smoothed_outcome(data_interest = dat_hfr$hist_allout_1,
                                              method = "mclust", initialization = TRUE,
                                              sampling = 0.05)

dat_hfr$hist_alltre_1 <- get_smoothed_outcome(data_interest = dat_hfr$hist_alltre_1,
                                              method = "mclust", initialization = TRUE,
                                              sampling = 0.05)

```

