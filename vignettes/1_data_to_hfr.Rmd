---
title: "Step 1. Converting data to hyperframes"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{1_data_to_hfr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(readr)

load("~/Dropbox/Research/geocausal/Data/airstr.csv")
load("~/Dropbox/Research/geocausal/Data/activ.csv")
load("~/Dropbox/Research/geocausal/Data/iraq_window.Rda")

activ <- activ[, c("latitude", "longitude", "date", "type_out")]
airstr <- airstr[, c("latitude", "longitude", "date", "Type")]
```

```{r setup, include = FALSE}
devtools::load_all()
#library(geocausal)
```

The purpose of this vignette is letting users convert dataframes with spatiotemporal dimensions to hyperframes with point process data. By the end of this vignette, users will be able to do the following tasks:

- task 1
- task 2

The functions that are introduced in this vignette are as follows:

- <tt>get_hfr</tt>
- <tt>vis_hfr</tt>

# Loading data

We will use two csv files: <tt>activ.csv</tt> and <tt>airstr.csv</tt>. 

- <tt>activ.csv</tt>: spatiotemporal information of outcomes (i.e., insurgencies) 
- <tt>airstr.csv</tt>: spatiotemporal information of treatment (i.e., airstrikes)

Let's first check what these datasets look like.

## Outcome data

In the dataset <tt>activ</tt>, locations of insurgencies are summarized by their latitudes and longitudes, with their onset captured by dates.

```{r}
head(activ)
```

There are three subtypes of insurgencies (column <tt>type_out</tt>): 

- improvised explosive devices (IED),
- small arms fire (SAF), and 
- other outcomes. 

```{r}
table(activ$type_out)
```

## Treatment data

The treatment data is similar, except for the fact that subtypes are now captured by column <tt>Type</tt>.

```{r}
head(airstr)
```

There are two sub-categories of airstrikes: 

- airstrikes and 
- shows of force (SOF: simulated airstrikes where no weapons are released).

```{r}
table(airstr$Type)
```

# Converting the data to hyperframes

Our first task is to convert data to a collection of point processes. Intuitively, we want to generate maps of all the locations of airstrikes and insurgencies for all subtypes and all dates. For dates and subtypes with no observations, we want to get an empty map.

[Figure here]

## <tt>get_hfr</tt> function

The key function here is <tt>get_hfr</tt> function. This function does the following:

1. aggregating all observations of each data and subtype, and converting them to a point process;
2. identifying dates with zero observations and generating an empty map for those dates; and
3. sorting everything and creating a hyperframe.

A hyperframe is just like a dataframe but each element can be anything, such as point processes and pixel images. That said, <tt>get_hfr</tt> function generates a summarized output of point processes as one hyperframe.

[Figure here]

To use this function, all you need to specify is the following arguments:

- <tt>data</tt>: the name of the dataframe that you want to pre-process;
- <tt>subtype_column</tt>: the name of the column that specifies subtypes (of treatment or outcome);
- <tt>window</tt>: an <tt>owin</tt> element (essentially, a map of your interest);
- <tt>time_column</tt>: the name of the column for time;
- <tt>time_range</tt>: the range of time periods of your interest;
- <tt>coordinates</tt>: the names of columns for longitudes and latitudes (in this order); and
- <tt>combined</tt>: an argument for generating a combined output.

If you set <tt>combined =  TRUE</tt>, then this function also returns point processes for each date, with every subtype combined. This is useful if you are interested in mapping all treatment or outcomes as one map.

## Converting data to hyperframes

So let's try it out. We first convert treatment data to a hyperframe.

```{r, warning = FALSE}
# Treatment
treatment_hfr <- get_hfr(data = airstr,
                         subtype_column = "Type",
                         window = iraq_window,
                         time_column = "date",
                         time_range = c("2007-02-23", "2008-07-05"),
                         coordinates = c("longitude", "latitude"),
                         combined = TRUE)
```

If you have multiple observations at the same time, then you will receive a warning message saying <tt>data contain duplicated points</tt>. This is a generic message that an internal function generates. As long as the data truly contains multiple observations happening at the same time, you can ignore this warning message.

The output of this function is a hyperframe, with each element being a point process, denoted as <tt>(ppp)</tt> in the output. 
```{r, warning = FALSE}
head(treatment_hfr)
```

Since we set <tt>combined = TRUE</tt>, we have a new column <tt>all_combined</tt>, which combines <tt>Airstrike</tt> and <tt>SOF</tt> for each day and returns an aggregated point process.

## Visualizing point processes

So how does each ppp look like? One way to visualize this is to treat this hyperframe just like a dataframe and plot each observation. For example, if you are interested in airstrikes on February 23, 2007, then you can plot it as follows.

```{r, warning = FALSE, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(treatment_hfr[which(treatment_hfr$time == "2007-02-23"), "Airstrike"],
     main = "")
```

In this plot, each circle represents an airstrike, and the boundaries show the borders of Iraq (as defined by the window).

This looks fine, but we understand that you may be interested in plotting airstrikes over several days, either aggregating data over several days or simply visualizing them separately. In this case, <tt>vis_hfr</tt> function is useful.

All you need to specify is the following:

- <tt>hfr</tt>: the name of the hyperframe;
- <tt>subtype_column</tt>: the name of the column that specifies subtypes (of treatment or outcome);
- <tt>time_column</tt>: the name of the column for time;
- <tt>time_range</tt>: the range of time periods of your interest;
- <tt>combined</tt>: whether you want to combine all observations as one plot; and
- <tt>marks</tt>: whether to use the same mark (if combined = TRUE).

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = treatment_hfr,
        subtype_column = "Airstrike",
        time_column = "time",
        time_range = c("2007-02-23", "2007-02-28"),
        combined = TRUE,
        marks = TRUE) 
```

If you specify <tt>marks = FALSE</tt>, then each day is represented by different shapes.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = treatment_hfr,
        subtype_column = "Airstrike",
        time_column = "time",
        time_range = c("2007-02-23", "2007-02-28"),
        combined = TRUE,
        marks = FALSE)
```

By setting <tt>combined = FALSE</tt>, you can also use this function to generate separate plots for all dates.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = treatment_hfr,
        subtype_column = "Airstrike",
        time_column = "time",
        time_range = c("2007-02-23", "2007-02-28"),
        combined = FALSE) 
```

## Combining hyperframes

Now that we understand what hyperframes and point processes look like, we can proceed to converting outcome data and combine the two hyperframes.

```{r, warning = FALSE}
# Outcome
outcome_hfr <- get_hfr(data = activ,
                       subtype_column = "type_out",
                       window = iraq_window,
                       time_column = "date",
                       time_range = c("2007-02-23", "2008-07-05"),
                       coordinates = c("longitude", "latitude"),
                       combined = TRUE)

# Combine the two
dat_hfr <- spatstat.geom::cbind.hyperframe(treatment_hfr, outcome_hfr[, -1])
names(dat_hfr)[names(dat_hfr) == "all_combined"] <- "all_treatment"
names(dat_hfr)[names(dat_hfr) == "all_combined.1"] <- "all_outcome"

head(dat_hfr)
```

With this hyperframe, we can then smooth point processes.







