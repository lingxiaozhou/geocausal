---
title: "Step 5. Obtaining observed densities"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{5_obs_density}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)

library(readr)
library(ggplot2)
library(furrr)
library(spatstat)
library(lubridate)
```

```{r setup, include = FALSE}
devtools::load_all()
#library(geocausal)
```

```{r load data, include = FALSE}
dat_hfr <- readRDS("~/geocausal/Data/dat_hfr_4.rds")

load("~/geocausal/Data/iraq_window.Rda")
load("~/geocausal/Data/sets_B.rds")

ps_covs <- c("logPopulation", "prior_rivers", "prior_roads", "All_Cities", "aid", 
             "hist_kinetic_1", "hist_kinetic_7", "hist_kinetic_30",
             "hist_allout_1", "hist_allout_7", "hist_allout_30", #Previously named as attacks
             "hist_SOF_1", "hist_SOF_7", "hist_SOF_30",
             "time.1", "time.2", "time.3",
             "Settle.IQ.G01", "Settle.IQ.G02", "Settle.IQ.G03", "Settle.IQ.G04",
             "Settle.IQ.G05", "Settle.IQ.G06", "Settle.IQ.G07", "Settle.IQ.G08",
             "Settle.IQ.G09", "Settle.IQ.G10", "Settle.IQ.G11", "Settle.IQ.G12",
             "Settle.IQ.G13", "Settle.IQ.G14", "Settle.IQ.G15", "Settle.IQ.G16",
             "Settle.IQ.G17", "Settle.IQ.G18")

setdiff(colnames(dat_hfr), ps_covs) #Not included in the covariates

```

# 1. Obtaining observed densities

Now that we have all the required data, let's move on to obtain the observed densities. The observed densities of treatment (in our example, airstrikes) will eventually be used to estimate causal effects.

The function that we use here is <tt>get_obs_density</tt>. This function has the following arguments.

- <tt>hfr</tt>: The hyperframe that we want to use
- <tt>treatment</tt>: The variable of interest
- <tt>rhs_list</tt>: A list of RHS variables
- <tt>ngrid</tt>: The number of grids (by default, 100)
- <tt>window</tt>: The window

<tt>get_obs_density</tt> function does the following tasks.

1. Fit an inhomogeneous Poisson model of <tt>treatment ~ rhs_list</tt>;
2. Obtain intensities $\lambda$ of the entire window by segmenting windows into $n = \text{ngrid}$ grid cells;
3. Integrate $\lambda$ over the entire window, which is equivalent to the estimate number of outcome events for each time period; and
4. Calculate the sum of log intensities of all observations for each time period.

The output of this function is a list of the following.

- <tt>ps_covs</tt>: A vector of the names of RHS variables
- <tt>ps_coefs</tt>: Coefficients of the model
- <tt>fitted_ps</tt>: Intensities as images for each time period
- <tt>cif_integral</tt>: Integrated intensities, which is the number of estimated outcome events for each time period
- <tt>sum_log_cif</tt>: The sum of log intensities of all observations for each time period

For the estimation of causal events, we will use <tt>sum_log_cif</tt>, but <tt>cif_integral</tt> and <tt>fitted_ps</tt> are also useful to evaluate how well our model estimates the number of outcome events.

Let's use the function <tt>get_obs_density</tt>. Since estimating the intensities over the entire window is computationally demanding, we use $\text{ngrid} = 100$.

```{r}
# List of RHS variables
ps_covs <- c("logPopulation", "prior_rivers", "prior_roads", "All_Cities", "aid", 
             "hist_kinetic_1", "hist_kinetic_7", "hist_kinetic_30",
             "hist_allout_1", "hist_allout_7", "hist_allout_30",
             "hist_SOF_1", "hist_SOF_7", "hist_SOF_30",
             "time.1", "time.2", "time.3",
             "Settle.IQ.G01", "Settle.IQ.G02", "Settle.IQ.G03", "Settle.IQ.G04",
             "Settle.IQ.G05", "Settle.IQ.G06", "Settle.IQ.G07", "Settle.IQ.G08",
             "Settle.IQ.G09", "Settle.IQ.G10", "Settle.IQ.G11", "Settle.IQ.G12",
             "Settle.IQ.G13", "Settle.IQ.G14", "Settle.IQ.G15", "Settle.IQ.G16",
             "Settle.IQ.G17", "Settle.IQ.G18")

# Get observed density over the entire window, for the entire period
obs_density <- get_obs_density(dat_hfr, "Airstrike", ps_covs, ngrid = 100, iraq_window)
##saveRDS(obs_density, file = "~/geocausal/Data/obs_density.rds")
```

Again, the output is a list of five elements that are summarized above. To see how each estimated intensities look like visually, we use plot function and select the date of interest. For example, if we are interested in the intensities of the first date of the data, then we can do the following. (We truncate the first 30 days from the original data, which is why the row ID is 31.)

```{r}
plot(obs_density$fitted_ps[1])
```

Also, we can compare the estimated and actual count measures by plotting them. 

In the original hyperframe <tt>dat_hfr</tt>, the column <tt>Airstrike</tt> is a list of ppp objects. In ppp objects, the number of points is saved as <tt>n</tt>. Also, the predicted number of airstrikes is saved as <tt>cif_integral</tt> of the output <tt>obs_density</tt>. Hence, we can do the following to compare the actual and predicted number of airstrikes. 

```{r}
# Actual count
actual_counts <- unlist(purrr::map(dat_hfr$Airstrike, function(x) x$n))

# Predicted count
predicted_counts <- obs_density$cif_integral

plot_compare <- data.frame(days = c(31:499),
                           actual_counts, predicted_counts) %>%
  ggplot() +
  geom_line(aes(x = days, y = actual_counts), color = "darkgray") +
  geom_line(aes(x = days, y = predicted_counts), color = "red") +
  theme_bw() +
  annotate("text", label = "Actual", x = 150, y = 50, size = 5, color = "darkgray") +
  annotate("text", label = "Predicted\n(ngrid = 100)", x = 400, y = 70, size = 5, color = "red") +
  labs(title = "Actual vs. predicted counts of airstrikes", x = "Days", y = "Count")

plot_compare
```

The predicted results follow the actual trend. Just in case, even if we increase the number of grid cells from 100 to 200, the results do not differ substantially.

```{r}
obs_density_res <- get_obs_density(dat_hfr, "Airstrike", ps_covs, ngrid = 200, iraq_window)
##saveRDS(obs_density_res, file = "~/geocausal/Data/obs_density_res.rds")

predicted_counts_res <- obs_density_res$cif_integral

plot_compare_res <- data.frame(days = c(31:499),
                               actual_counts, predicted_counts, predicted_counts_res) %>%
  ggplot() +
  geom_line(aes(x = days, y = actual_counts), color = "darkgray") +
  geom_line(aes(x = days, y = predicted_counts), color = "red") +
  geom_line(aes(x = days, y = predicted_counts_res), color = "blue") +
  theme_bw() +
  annotate("text", label = "Actual", x = 150, y = 50, size = 5, color = "darkgray") +
  annotate("text", label = "Predicted\n(ngrid = 100)", x = 400, y = 70, size = 5, color = "red") +
  annotate("text", label = "Predicted\n(ngrid = 200)", x = 430, y = 50, size = 5, color = "blue") +
  labs(title = "Actual vs. predicted counts of airstrikes", x = "Days", y = "Count")

plot_compare_res
```

```{r}
plot_compare_res_residual <- data.frame(days = c(31:499),
                                        res_ng_100 = predicted_counts - actual_counts,
                                        res_ng_200 = predicted_counts_res - actual_counts) %>%
  ggplot() +
  geom_line(aes(x = days, y = res_ng_100), color = "red") +
  geom_line(aes(x = days, y = res_ng_200), color = "blue") +
  theme_bw() +
  annotate("text", label = "Predicted\n(ngrid = 100)", x = 400, y = 70, size = 5, color = "red") +
  annotate("text", label = "Predicted\n(ngrid = 200)", x = 430, y = 40, size = 5, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residual plot comparing ngrid = 100 and 200", x = "Days", y = "Residual")

plot_compare_res_residual
```

# Out-of-sample prediction

Thought experiment:

- Dividing into test and training set
- Use the entire data to model, and then apply it to a subset of the data (eg, Baghdad)

## Using a subset of data to fit the model

```{r}
# 80% training
out_obs_density_8 <- predict_obs_density(dat_hfr, ratio = 0.8, "Airstrike", 
                                         ps_covs, ngrid = 100, iraq_window)
predicted_out_8 <- out_obs_density_8$cif_integral

# 70% training
out_obs_density_7 <- predict_obs_density(dat_hfr, ratio = 0.7, "Airstrike", 
                                         ps_covs, ngrid = 100, iraq_window)
predicted_out_7 <- out_obs_density_7$cif_integral

##out_obs_density <- list(out_obs_density_8, out_obs_density_7)
##saveRDS(out_obs_density, file = "~/geocausal/Data/out_obs_density.rds")

# Plot
plot_out_of_sample <- data.frame(days = c(31:499),
                                 actual_counts, predicted_counts, 
                                 predicted_out_8, predicted_out_5) %>%
  ggplot() +
  geom_line(aes(x = days, y = actual_counts), color = "darkgray") +
  geom_line(aes(x = days, y = predicted_counts), color = "red") +
  geom_line(aes(x = days, y = predicted_out_8), color = "blue") +
  geom_line(aes(x = days, y = predicted_out_7), color = "green4") +
  theme_bw() +
  annotate("text", label = "Actual", x = 150, y = 50, size = 5, color = "darkgray") +
  annotate("text", label = "Predicted", x = 470, y = 20, size = 5, color = "red") +
  geom_vline(xintercept = 499, linetype = "dashed", color = "red") +
  annotate("text", label = "Out-of-sample\n(80%)", x = 430, y = 50, size = 5, color = "blue") +
  geom_vline(xintercept = out_obs_density_8$train_max_row, linetype = "dashed", color = "blue") +
  annotate("text", label = "Out-of-sample\n(70%)", x = 430, y = 80, size = 5, color = "green4") +
  geom_vline(xintercept = out_obs_density_7$train_max_row, linetype = "dashed", color = "green4") +
  labs(title = "Actual vs. predicted counts of airstrikes", x = "Days", y = "Count")

plot_out_of_sample
```




```{r}
plot_out_of_sample_residual <- data.frame(days = c(31:499),
                                          res_pred = predicted_counts - actual_counts,
                                          res_out_8 = predicted_out_8 - actual_counts,
                                          res_out_7 = predicted_out_7 - actual_counts) %>%
  ggplot() +
  geom_line(aes(x = days, y = res_pred), color = "red") +
  geom_line(aes(x = days, y = res_out_8), color = "blue") +
  geom_line(aes(x = days, y = res_out_7), color = "green4") +
  theme_bw() +
  annotate("text", label = "Predicted", x = 450, y = -25, size = 5, color = "red") +
  geom_vline(xintercept = 499, linetype = "dashed", color = "red") +
  annotate("text", label = "Out-of-sample\n(80%)", x = 430, y = -50, size = 5, color = "blue") +
  geom_vline(xintercept = out_obs_density_8$train_max_row, linetype = "dashed", color = "blue") +
  annotate("text", label = "Out-of-sample\n(70%)", x = 410, y = 50, size = 5, color = "green4") +
  geom_vline(xintercept = out_obs_density_7$train_max_row, linetype = "dashed", color = "green4") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residual plot comparing 80% and 70% allocations", x = "Days", y = "Residual")

plot_out_of_sample_residual
```

## Using the entire data to fit the model, and then integrate over a subset of the data

- Set ratio = 1 and change the window
- First use Baghdad

```{r}
# Baghdad
obs_density_baghdad <- predict_obs_density(dat_hfr, ratio = 1, "Airstrike", 
                                           ps_covs, ngrid = 100, window = sets_B$Baghdad)
predicted_baghdad <- obs_density_baghdad$cif_integral

## Calculate the actual count
airstrikes <- dat_hfr$Airstrike

for(i in 1:nrow(dat_hfr)){
  spatstat.geom::Window(airstrikes[[i]]) <- sets_B$Baghdad
}

actual_baghdad <- unlist(purrr::map(airstrikes, function(x) x$n))

# Plot (Baghdad)
plot_compare_bag <- data.frame(days = c(31:499),
                               actual_baghdad, predicted_baghdad) %>%
  ggplot() +
  geom_line(aes(x = days, y = actual_baghdad), color = "darkgray") +
  geom_line(aes(x = days, y = predicted_baghdad), color = "red") +
  theme_bw() +
  annotate("text", label = "Actual", x = 150, y = 50, size = 5, color = "darkgray") +
  annotate("text", label = "Predicted", x = 400, y = 70, size = 5, color = "red") +
  labs(title = "Actual vs. predicted counts of airstrikes (Baghdad)", x = "Days", y = "Count") + ylim(0, 100)

plot_compare_bag
```

```{r}
plot_baghdad_residual <- data.frame(days = c(31:499),
                                        res_bag = predicted_baghdad - actual_baghdad) %>%
  ggplot() +
  geom_line(aes(x = days, y = res_bag), color = "red") +
  theme_bw() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residual plot (Baghdad)", x = "Days", y = "Residual") + ylim(-100, 100)

plot_baghdad_residual
```


```{r}
# Outside of Baghdad
obs_density_out_bag <- predict_obs_density(dat_hfr, ratio = 1, "Airstrike", 
                                           ps_covs, ngrid = 100, window = sets_B$outside_Baghdad)
predicted_out_bag <- obs_density_out_bag$cif_integral

## Calculate the actual count
airstrikes <- dat_hfr$Airstrike

for(i in 1:nrow(dat_hfr)){
  spatstat.geom::Window(airstrikes[[i]]) <- sets_B$outside_Baghdad
}

actual_out_bag <- unlist(purrr::map(airstrikes, function(x) x$n))

# Plot (Outside of baghdad)
plot_compare_out_bag <- data.frame(days = c(31:499),
                                   actual_out_bag, predicted_out_bag) %>%
  ggplot() +
  geom_line(aes(x = days, y = actual_out_bag), color = "darkgray") +
  geom_line(aes(x = days, y = predicted_out_bag), color = "blue") +
  theme_bw() +
  annotate("text", label = "Actual", x = 150, y = 50, size = 5, color = "darkgray") +
  annotate("text", label = "Predicted", x = 400, y = 40, size = 5, color = "blue") +
  labs(title = "Actual vs. predicted counts of airstrikes (Outside of Baghdad)", x = "Days", y = "Count")  +  ylim(0, 100)

plot_compare_out_bag
```

```{r}
plot_out_bag_residual <- data.frame(days = c(31:499),
                                        res_out_bag = predicted_out_bag - actual_out_bag) %>%
  ggplot() +
  geom_line(aes(x = days, y = res_out_bag), color = "blue") +
  theme_bw() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residual plot (Outside of Baghdad)", x = "Days", y = "Residual") + ylim(-100, 100)

plot_out_bag_residual
```
