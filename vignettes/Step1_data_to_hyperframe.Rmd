---
title: "Step 1. Converting data to hyperframes"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Step 1. Converting data to hyperframes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, include = FALSE}
library(geocausal)

airstrikes <- geocausal::airstrikes
insurgencies <- geocausal::insurgencies
iraq_window <- geocausal::iraq_window
```

To demonstrate the use of our package, we employ two datasets: `airstrikes` and `insurgencies`. These datasets represent spatiotemporal data of airstrikes and insurgencies in Iraq from March 2007 to June 2007. Using this data, we aim to investigate the impact of airstrikes on the number of insurgencies in Iraq.

The first step of spatiotemporal causal inference is to convert dataframes into an object called hyperframe. Essentially, a hyperframe is a dataframe in which each cell can contain various types of objects, including pixel images and point processes. Users can convert dataframes into hyperframes using the function `get_hfr()`.

# Data

It is important to note that location information should be stored in decimal degree format. When using `geocausal`, if the original data is not in the decimal degree format, users are advised to convert it to this format. Furthermore, the time variable must be in numeric form.

# Converting Data into Hyperframes

Our initial task is to transform data into a collection of point processes. Intuitively, we aim to create maps that depict the locations of both airstrikes and insurgencies across all subtypes and dates. For dates and subtypes lacking observations, an empty map should be generated.

The key function utilized for this procedure is `get_hfr()`. This function performs the following tasks:

1. Aggregates all observations by dates and subtypes, then converts them into a point process;
2. Identifies dates without observations and produces an empty map for these dates; and
3. Sort all data and constructs a hyperframe.

```{r, warning = FALSE}
# 1. Treatment data

## 1-1. Convert time variable into numerics
airstrikes$time <- as.numeric(airstrikes$date - min(airstrikes$date) + 1)

## 1-2. Generate a hyperframe
treatment_hfr <- get_hfr(data = airstrikes,
                         subtype_column = "type",
                         window = iraq_window,
                         time_column = "time",
                         time_range = c(1, max(airstrikes$time)),
                         coordinates = c("longitude", "latitude"),
                         combined = TRUE)

# 2. Outcome data

## 2-1. Convert time variable into numerics
insurgencies$time <- as.numeric(insurgencies$date - min(insurgencies$date) + 1)

outcome_hfr <- get_hfr(data = insurgencies,
                       subtype_column = "type",
                       window = iraq_window,
                       time_column = "time",
                       time_range = c(1, max(insurgencies$time)),
                       coordinates = c("longitude", "latitude"),
                       combined = TRUE)

# 3. Combine two hyperframes
dat_hfr <- spatstat.geom::cbind.hyperframe(treatment_hfr, outcome_hfr[, -1])
names(dat_hfr)[names(dat_hfr) == "all_combined"] <- "all_treatment"
names(dat_hfr)[names(dat_hfr) == "all_combined.1"] <- "all_outcome"
```

The output is a hyperframe, where each element is a point process, denoted as `(ppp)` in the output.

```{r, warning = FALSE}
head(dat_hfr)
```

# Visualization

To visualize hyperframes, users can use the `vis_hfr()` function.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = dat_hfr,
        subtype_column = c("Airstrike", "SOF"),
        time_column = "time",
        range = c(1, 5),
        combined = TRUE) 
```
