---
title: "Step 3. Preparing covariates"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{3_preparing_covariates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)

library(readr)
library(ggplot2)
library(furrr)
library(spatstat)
```

```{r setup, include = FALSE}
devtools::load_all()
#library(geocausal)
```

```{r load data, include = FALSE}
load_path <- "~/geocausal/Data/covariates"

load("~/geocausal/Data/iraq_window.Rda")
load(paste0(load_path, "/cities_dist.dat"))
load(paste0(load_path, "/sectarian.dat"))
load(paste0(load_path, "/rivers_dist.dat"))
load(paste0(load_path, "/routes_dist.dat"))
load(paste0(load_path, "/settle_dist.dat"))
load(paste0(load_path, "/aid_district.dat"))

subset_dates <- as.Date(c("2007/01/20", "2010/01/20"))

aid_district <- subset(aid_district, USE_DATE >= subset_dates[1] &
                         USE_DATE <= subset_dates[2])

## Prepare dat_hfr
dat_hfr <- readRDS("~/geocausal/Data/dat_hfr_2.rds")

sof_priority_coef <- 6  # For current SOFs
hist_priority_coefs <- c(6, 6, 6)  # For previous airstrikes, outcomes, SOFs
covs_priority_coefs <- list(cities = seq(2, 10, length.out = 5),
                            rivers = 3, roads = 3, settle = 12)

ps_covs <- c("logPopulation", "prior_rivers", "prior_roads", "All_Cities",
             "aid", "prior_PrevKinetic.1", "prior_PrevKinetic.7", "prior_PrevKinetic.30",
             "prior_PrevAttacks.1", "prior_PrevAttacks.7", "prior_PrevAttacks.30",
             "prior_PrevSOF.1", "prior_PrevSOF.7", "prior_PrevSOF.30",
             "time.1", "time.2", "time.3",
             "Settle.IQ.G01", "Settle.IQ.G02", "Settle.IQ.G03", "Settle.IQ.G04",
             "Settle.IQ.G05", "Settle.IQ.G06", "Settle.IQ.G07", "Settle.IQ.G08",
             "Settle.IQ.G09", "Settle.IQ.G10", "Settle.IQ.G11", "Settle.IQ.G12",
             "Settle.IQ.G13", "Settle.IQ.G14", "Settle.IQ.G15", "Settle.IQ.G16",
             "Settle.IQ.G17", "Settle.IQ.G18")
```

In this vignette, we will walk through the covariates. Our example considers the following covariates:

- <tt>sectarian</tt>: settlement patterns and the population (logged, in 2003) of the governorate in which the airstrikes took place;
- <tt>cities_dist</tt>: distances from major cities;
- <tt>rivers_dist</tt>: distances from rivers;
- <tt>routes_dist</tt>: distances from road networks;
- <tt>settle_dist</tt>: distances from local settlements in each of the Iraqi districts; and
- <tt>aid_district</tt>: the amount of aid spent (in U.S. dollars) in each Iraqi district in the past month.

# Covariates

## The population (logged, in 2003) and settlement patterns

The data <tt>sectarian</tt> is a collection of pixel images.

```{r}
sectarian
```

For each ethnic group (Shia, Sunni, Christians, Turcomans, and Shia/Sunni mixed), we have a map of settlement patterns.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(sectarian$Shia, main = "Shia")
plot(sectarian$Sunni, main = "Sunni")
plot(sectarian$Christians, main = "Christians")
plot(sectarian$Turcomans, main = "Turcomans")
plot(sectarian$Mixed_ShSu, main = "Mixed Shia/Sunni")
```

For the population, we have logged population in 2003 of each of the Iraqi districts as a pixel image.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(sectarian$total_pop, main = "Total population")
```

Let's save each of them as a separate column of the hyperframe.

```{r}
dat_hfr$Shia <- spatstat.geom::as.im(sectarian$Shia, dimyx = 256)
dat_hfr$Sunni <- spatstat.geom::as.im(sectarian$Sunni, dimyx = 256)
dat_hfr$Christians <- spatstat.geom::as.im(sectarian$Christians, dimyx = 256)
dat_hfr$Turcomans <- spatstat.geom::as.im(sectarian$Turcomans, dimyx = 256)
dat_hfr$MixedShSu <- spatstat.geom::as.im(sectarian$Mixed_ShSu, dimyx = 256)
dat_hfr$logPopulation <- spatstat.geom::as.im(log(sectarian$total_pop), dimyx = 256)
```

## Distances from major cities

<tt>cities_dist</tt> is a hyperframe of point processes and pixel images.

```{r}
head(cities_dist)
```

The point processes summarize the locations of major cities based on the population size.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = cities_dist,
        subtype_column = "Points",
        time_column = NA,
        range = c(1, 6),
        combined = TRUE)
```

The pixel images show the distances from major cities.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = cities_dist,
        subtype_column = "distance",
        time_column = NA,
        range = c(1, 6),
        combined = FALSE,
        scale_max = 8) 
```

We save these distances after multiplying by some constants and exponentiating them. We ignore small cities whose population < 50k. Additionally, we combine all five pixel images as one map and save it as a map that shows distances from all types of cities.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
covs <- c(2, 4, 6, 8, 10)

for (jj in 1 : 5) {
  dat_hfr$Extra <- exp(- covs[jj] * cities_dist$distance[[jj]])
  names(dat_hfr)[length(names(dat_hfr))] <- paste0("Cities.", jj)
}

dat_hfr$All_Cities <- dat_hfr$Cities.1 + dat_hfr$Cities.2 + dat_hfr$Cities.3 +
  dat_hfr$Cities.4 + dat_hfr$Cities.5

plot(dat_hfr$All_Cities[1], main = "Distances from all cities")
```

## Distances from rivers

<tt>rivers_dist</tt> is a pixel image that shows distances from major rivers.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(rivers_dist, main = "Distance from rivers", zlim = c(0, 3))
```

Let's save it as a column of the hyperframe. For purely visualization purposes, we multiply the distances by -3 and then exponentiate it before saving it.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(exp(- 3 * rivers_dist))
dat_hfr$prior_rivers <- exp(- 3 * rivers_dist)
```

## Distances from roads

<tt>routes_dist</tt> is also a pixel image that shows distances from road networks.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(routes_dist, main = "Distance from routes", zlim = c(0, 2))
```

Similarly, save it as a column after multiplying it by -3 and exponentiating it.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
plot(exp(-3 * routes_dist))
dat_hfr$prior_roads <- exp(-3 * routes_dist)
```

## Distances from settlements

The structure of <tt>settle_dist</tt> is similar to <tt>cities_dist</tt>. It is a hyperframe with point processes and pixel images.

```{r}
head(settle_dist)
```

The point processes show the locations of settlements in each Governorate in Iraq.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = settle_dist,
        subtype_column = "Points",
        time_column = NA,
        range = c(1, 18),
        combined = FALSE) 
```

Additionally, pixel images show the distances from the settlements.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
vis_hfr(hfr = settle_dist,
        subtype_column = "distance",
        time_column = NA,
        range = c(1, 18),
        combined = FALSE,
        scale_max = 10) 
```

We save each of these after multiplying by some constants and then exponentiating them.

```{r}
for (jj in 1 : 18) {
  dat_hfr$Extra <- exp(- 12 * settle_dist$distance[[jj]])
  col_name <- paste0('Settle.', rownames(settle_dist)[jj])
  names(dat_hfr)[length(names(dat_hfr))] <- col_name
}
```

## The amount of aid spent (in U.S. dollars)

The aid data <tt>aid_district</tt> is summarized as the amount spent in the previous month in a district.

```{r}
head(aid_district)
```

We then convert it to pixel images.

```{r}
#iraq3 <- rgdal::readOGR(dsn = "~/geocausal/Data/covariates/Iraq Districts/.")
#dat_hfr$aid <- NULL #Modified

#get_aid_data <- function(dat_date) {
#  this_iraq3 <- iraq3
#  this_date <- dat_date
#  this_aid <- subset(aid_district, USE_DATE == this_date)
#  this_aid[, USE_DATE := NULL]
#  this_iraq3@data <- merge(this_iraq3@data, this_aid, by.x = "ADM3NAME",
#                           by.y = "District", all.x = TRUE)
#  this_iraq3@data$log_construct[is.na(this_iraq3@data$log_construct)] <- 0

#  r <- raster::raster(ncol = 128, nrow = 128)
#  raster::extent(r) <- raster::extent(this_iraq3)
#  rp <- raster::rasterize(this_iraq3, r, "log_construct")
#  rpim <- spatstat.geom::as.im(rp)
#  spatstat.geom::Window(rpim) <- iraq_window
#  return(rpim)
#}

#dat_hfr$aid <- furrr::future_map(dat_hfr$time, get_aid_data)
```

Each of pixel images is the summary of aid spending over the past one month in each district.

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
dat_hfr <- readRDS("~/geocausal/Data/dat_hfr_3.rds")

vis_hfr(hfr = dat_hfr,
        subtype_column = "aid",
        time_column = "time",
        range = c("2007-02-23", "2007-02-28"),
        combined = FALSE,
        scale_max = 20)
```

## Splines of time

Additionally, we have temporal splines as a covariate. This is the B-spline basis matrix for a natural cubic spline, using days (1 to 499) as predictors. We set the degree of freedom = 3.

```{r}
time_splines <- splines::ns(1 : nrow(dat_hfr), df = 3)
#for (jj in 1 : 3) {
#  dat_hfr$Extra <- time_splines[, jj]
#  names(dat_hfr)[ncol(dat_hfr)] <- paste0("time.", jj)
#}

head(time_splines)
```

The values of each element look like as follows:

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
data.frame(spline = c(time_splines[, 1], time_splines[, 2], time_splines[, 3]),
           spline_id = as.factor(c(rep(1, nrow(dat_hfr)), 
                                   rep(2, nrow(dat_hfr)), 
                                   rep(3, nrow(dat_hfr)))),
           Day = c(rep(1:nrow(dat_hfr), 3))) -> spline_data

ggplot(spline_data) +
  geom_point(aes(y = spline, x = Day, color = spline_id), size = 0.1) +
  theme_bw() +
  labs(title = "Time splines")
```

```{r, include = FALSE}
#saveRDS(dat_hfr, file = "~/geocausal/Data/dat_hfr_3.rds")
```