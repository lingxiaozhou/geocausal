---
title: "Step 6. Obtaining counterfactual densities"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{6_counterfactual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)

library(readr)
library(ggplot2)
```

```{r setup, include = FALSE}
devtools::load_all()
#library(geocausal)
```

```{r load data, include = FALSE}
dat_hfr <- readRDS("~/geocausal/Data/dat_hfr_4.rds")
airstr_base <- get(load("~/geocausal/Data/airstr_base.csv"))
load("~/geocausal/Data/covariates/routes_dist.dat")
load("~/geocausal/Data/iraq_window.Rda")
load("~/geocausal/Data/windows.RData")
# Or, iraq_window <- get_window(load_path = "~/geocausal/Data/iraq_boundary_adm1/.")
load("~/geocausal/Data/covariates/sectarian.dat")
airstr_base <- airstr_base[, c("latitude", "longitude", "date", "Type")] 
##Data used here is not included in the analysis, also it excludes SOF
obs_density_surge <- readRDS("~/geocausal/Data/obs_density_surge.rds")
```

# 1. Obtaining the baseline density

- Use the data from 2006 to obtain the baseline density

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
# Data
head(airstr_base)
range(airstr_base$date)

# Get baseline density
baseline <- get_baseline_density(data = airstr_base, 
                                 coordinates = c("longitude", "latitude"),
                                 window = iraq_window,
                                 grayscale = FALSE)

baseline$density_plot
```
Get the summary and plot so that we can see the expected number of airstrikes.

```{r}
# Get the target number
baseline_summary <- get_baseline_summary(data = airstr_base, 
                                         time_column = "date")

baseline_summary$quantile
baseline_summary$mean
baseline_summary$variance
baseline_summary$plot
```

# 2. Obtaining the counterfactual density by simple multiplication

Then first try the simple multiplication. Since the baseline density is standardized, the target_number is already the target expectation.

```{r}
# Counterfactual: Simple multiplication
baseline_density <- baseline$density
target_number <- 3

counterfactual_multiply <- get_counterfactual_density(baseline_density = baseline_density,
                                                      expected_number = target_number,
                                                      window = iraq_window,
                                                      grayscale = FALSE)

counterfactual_multiply$plot
```

# 3. Obtaining the counterfactual density by shifting locations

## 3.1. Obtaining the densities to construct a power density

```{r}
# Density 1: Distance from focuses (i.e., points)
dist_from_focus <- get_dist_focus(window = iraq_window,
                                  longitude = c(43.158),
                                  latitude = c(36.349), #Coodinates (lon and lat) of Mosul
                                  grayscale = FALSE,
                                  mile = FALSE)

dist_from_focus$plot #ggplot
```

```{r}
# Another example (Mosul and Baghdad)
dist_from_focus2 <- get_dist_focus(window = iraq_window,
                                   longitude = c(44.366, 43.158), #Baghdad and Mosul
                                   latitude = c(33.315, 36.349),
                                   grayscale = FALSE,
                                   mile = FALSE)

dist_from_focus2$plot
```

```{r}
dist_mosul <- exp(-dist_from_focus[[1]]/1000)/spatstat.geom::integral(dist_from_focus[[1]])
plot(dist_mosul)
```

```{r}
dist_mos_bagh <- exp(-dist_from_focus2[[1]]/1000)/spatstat.geom::integral(dist_from_focus2[[1]])
plot(dist_mos_bagh)
```

```{r}
# Density 2: Distance from routes (i.e., lines)
shapefile_path = "~/geocausal/Data/covariates/primary_routes/primary_routes.shp"
window = iraq_window

# distmap with converted scale

crs_id <- 3200
window <- iraq_window

# Re-coordinate the shapefile
shp <- sf::st_read("~/geocausal/Data/covariates/primary_routes/.")
roads <- sf::st_geometry(shp)
roads <- roads %>% sf::st_transform(roads, crs = crs_id) # Convert to meters
roads_psp <- spatstat.geom::as.psp(roads)
roads_psp
plot(roads_psp)

roads_psp$window$xrange[1] = roads_psp$window$xrange[1] - 0.05*roads_psp$window$xrange[1]
roads_psp$window$xrange[2] = roads_psp$window$xrange[2] + 0.05*roads_psp$window$xrange[1]
roads_psp$window$yrange[1] = roads_psp$window$yrange[1] - 0.05*roads_psp$window$xrange[1]
roads_psp$window$yrange[2] = roads_psp$window$yrange[2] + 0.05*roads_psp$window$xrange[1]

plot(roads_psp)

# Convert owin into sp objects  
window_sp <- convert_owin_into_sf(window)
polygon_sf <- window_sp[[4]]

# Re-coordinate the window
polygon_sf <- polygon_sf %>% sf::st_set_crs(4326) #4326 = decimal long/lat
poly <- sf::st_transform(polygon_sf, crs = crs_id) #eg, 3200 = meters, specific to iraq

window_recoord <- spatstat.geom::as.owin(poly)
window_recoord

t <- spatstat.geom::distmap(roads_psp, dimyx = 1024)
t_km <- t/1000
plot(t_km)

spatstat.geom::Window(t_km) <- window_recoord

plot(t_km) #The coordinates are still km
t_km_rescaled <- rescale(t_km, factor = 1/111319.5) #Very, very approximate

```

```{r}
# Alternatively...slow but we can do this with geosphere
shapefile_path = "~/geocausal/Data/covariates/primary_routes/primary_routes.shp"

# Need to modify shapefiles a bit first
shp <- sf::st_read(shapefile_path)

lapply(1:length(unique(shp$ROUTE_NUMB)), function(x) {
  temp <- sf::st_combine(shp$geometry[which(shp$ROUTE_NUMB == unique(shp$ROUTE_NUMB)[x])])
  temp[[1]][[1]] <- do.call("rbind", temp[[1]])
  
  while (length(temp[[1]]) > 1) {
      temp[[1]][[2]] <- NULL
    }
  
  return(temp[[1]])
  }) -> line_dat

length(line_dat[[30]]) #Remove one missing element
line_dat[[30]] <- NULL

# Then run the function (This method is extendable to polygons as well (see dist2Line function))
## If line data is available
dist_from_line <- get_dist_line(window = iraq_window, 
                                line_data = line_dat,
                                mile = FALSE,
                                grayscale = FALSE,
                                resolution = 0.1,
                                distfun = distHaversine)

dist_from_line$plot

## If not (takes a lot of time)
dist_from_line <- get_dist_line(window = iraq_window, 
                                path_to_shapefile = shapefile_path,
                                mile = FALSE,
                                grayscale = FALSE,
                                resolution = 0.1)

distance_from_line$plot
```

```{r}
# Density 3: Sectarian (polygon)

sunni <- sectarian$Sunni
plot(sunni)
```

```{r}
# Density 4: Elevation
elevation_data <- get_elevation(load_path = "~/geocausal/Data/iraq_boundary_adm1/.",
                                z = 5)

elevation <- elevation_data$im
elevation_data$plot

## Convert it to terrain (slope)
#terrain_data <- raster::terrain(elevation_data, opt = "slope")
#terrain_im <- maptools_as.im.RasterLayer(terrain_data)
```

## 3.2. Obtaining power densities

```{r}
target_sunni_routes <- list(sunni, dist_from_routes)
priorities <- c(2, 2)

# Example 1: Sectarian x Routes
power_sunni_routes <- get_power_density(target_densities = target_sunni_routes, 
                                        priorities = priorities, 
                                        window = iraq_window,
                                        grayscale = FALSE)
plot(power_sunni_routes$density)
power_sunni_routes$plot
```

```{r}
# Example 2: Sectarian x City
target_sunni_mosul <- list(sunni, distance_from_focus)
power_sunni_mosul <- get_power_density(target_densities = target_sunni_mosul, 
                                       priorities = priorities, 
                                       window = iraq_window,
                                       grayscale = FALSE)

power_sunni_mosul$plot
```

```{r}
# Example 3-1: Roads x City
target_road_mosul <- list(distance_from_routes, distance_from_focus)
power_road_mosul <- get_power_density(target_densities = target_road_mosul, 
                                      priorities = priorities, 
                                      window = iraq_window,
                                      grayscale = FALSE)

power_road_mosul$plot
```

```{r}
# Example 4: Elevation x Sectarian
target_elevation_sunni <- list(elevation, sunni)
power_elevation_sunni <- get_power_density(target_densities = target_elevation_sunni,
                                           priorities = priorities,
                                           window = iraq_window,
                                           grayscale = FALSE)

plot(power_elevation_sunni$density)
```

For visualization purposes, consider two scenarios (Mosul+Roads vs Mosul+Bagh)

```{r}
# Counterfactual 1: Mosul and roads
dist_routes <- exp(-routes_dist)/spatstat.geom::integral(routes_dist)

target_mosul_road <- list(dist_mosul, dist_routes)
power_mosul_road <- get_power_density(target_densities = target_mosul_road,
                                           priorities = c(5, 1),
                                           window = iraq_window,
                                           grayscale = FALSE)

plot(power_mosul_road$density)
```

```{r}
# Counterfactual 2: Mosul and Bagh
target_mos_bagh <- list(dist_mos_bagh)
power_mos_bagh <- get_power_density(target_densities = target_mos_bagh,
                                           priorities = c(3),
                                           window = iraq_window,
                                           grayscale = FALSE)

plot(power_mos_bagh$density)
```


## 3.3. Obtaining counterfactual densities

```{r}
# Counterfactual 1
counterfactual_mosul_road <- get_counterfactual_density(baseline_density = baseline_density,
                                                      expected_number = target_number,
                                                      power_density = power_mosul_road$density,
                                                      window = iraq_window,
                                                      grayscale = FALSE)

counterfactual_mosul_road$plot
```

```{r}
# Counterfactual 2
counterfactual_mos_bagh <- get_counterfactual_density(baseline_density = baseline_density,
                                                      expected_number = target_number,
                                                      power_density = power_mos_bagh$density,
                                                      window = iraq_window,
                                                      grayscale = FALSE)

counterfactual_mos_bagh$plot
```

# 3.4 Simulation

Simulation and visualization exercises for power density
- Suppose that we keep the distance from cities as it is with alpha = 2 and want to see how changing alpha from 1 to 5 for routes affects the power density...

```{r}
#dist_routes <- distance_from_routes/spatstat.geom::integral(distance_from_routes)
#plot(dist_routes)

# For counterfactual scenario 1

sim_power_mosul <- simulate_power_density(target_densities = list(dist_routes), #This must be a list element
                                    density_to_manipulate = dist_mosul,
                                    priorities = 1,
                                    priorities_for_manipulation = c(1, 2, 5, 10, 15, 20),
                                    window = iraq_window,
                                    grayscale = FALSE)

plot(sim_power_mosul$densities[[6]])
sim_power_mosul$plot #Somehow not working (images incompatible...)
```

Simulation for counterfactual densities

```{r}
# Simulation
sim_counter_mosul <- simulate_counterfactual_density(expected_number = target_number,
                                               baseline_density = baseline_density,
                                               power_simulation_results = sim_power_mosul,
                                               window = iraq_window,
                                               grayscale = FALSE)

sim_counter_mosul$plot #Not working
```

Then choose which density? Use these as inputs

```{r}
expectation_mosul <- get_distance_based_expectation(counterfactual_simulation_results = sim_counter_mosul, 
                                                    entire_window = iraq_window, 
                                                    density_of_interest = dist_mosul,
                                                    distance_map = dist_from_focus,
                                                    grayscale = FALSE,
                                                    expectation_use_raw = TRUE)

expectation_mosul
```

Simulate with the opposite

```{r}
sim_power2 <- simulate_power_density(target_densities = list(distance_from_focus), #This must be a list element
                                     density_to_manipulate = dist_routes,
                                     distance_map = dist_from_focus,
                                     priorities = 2,
                                     priorities_for_manipulation = c(1, 2, 5, 10, 15, 20),
                                     window = iraq_window,
                                     grayscale = FALSE)

sim_counter2 <- simulate_counterfactual_density(expected_number = target_number,
                                                baseline_density = baseline_density,
                                                power_simulation_results = sim_power2,
                                                window = iraq_window,
                                                grayscale = FALSE)

expectation_road <- get_distance_based_expectation(counterfactual_simulation_results = sim_counter2, 
                                                   entire_window = iraq_window, 
                                                   density_of_interest = dist_routes,
                                                   grayscale = FALSE)

expectation_road
```

# 4. Get the log density

Finally, save these for the next vignette.

```{r}
counter_dens_1 <- sim_counter_mosul$densities[[6]] #Mosul x roads
counter_dens_2 <- counterfactual_mos_bagh$density

plot(counter_dens_1)
plot(counter_dens_2)
counter_d <- list(counter_dens_1, counter_dens_2)
#save(counter_d, file = "~/geocausal/Data/counter_d.Rda") #Saved two counter densities
```


