---
title: "Step 6. Obtaining counterfactual densities"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{6_counterfactual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type = "text/css">
h1.title {
  font-size: 30px;
}
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
    font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
div#TOC li {
    list-style:none;
    background-image:none;
    background-repeat:none;
    background-position:0; 
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)

library(readr)
library(ggplot2)
```

```{r setup, include = FALSE}
devtools::load_all()
#library(geocausal)
```

```{r load data, include = FALSE}
dat_hfr <- readRDS("~/geocausal/Data/dat_hfr_4.rds")
airstr_base <- get(load("~/geocausal/Data/airstr_base.csv"))
load("~/geocausal/Data/covariates/routes_dist.dat")
load("~/geocausal/Data/iraq_window.Rda")
load("~/geocausal/Data/windows.RData")
# Or, iraq_window <- get_window(load_path = "~/geocausal/Data/iraq_boundary_adm1/.")
load("~/geocausal/Data/covariates/sectarian.dat")
airstr_base <- airstr_base[, c("latitude", "longitude", "date", "Type")] 
##Data used here is not included in the analysis, also it excludes SOF
```

# 1. Obtaining the baseline density

- Use the data from 2006 to obtain the baseline density

```{r, out.height=400, out.width=600, fig.dim = c(9, 6)}
# Data
head(airstr_base)
range(airstr_base$date)

# Get baseline density
baseline <- get_baseline_density(data = airstr_base, 
                                 coordinates = c("longitude", "latitude"),
                                 window = iraq_window,
                                 grayscale = FALSE)

baseline$density_plot
```
Get the summary and plot so that we can see the expected number of airstrikes.

```{r}
# Get the target number
baseline_summary <- get_baseline_summary(data = airstr_base, 
                                         time_column = "date")

baseline_summary$quantile
baseline_summary$mean
baseline_summary$variance
baseline_summary$plot
```

# 2. Obtaining the counterfactual density by simple multiplication

Then first try the simple multiplication. Since the baseline density is standardized, the target_number is already the target expectation.

```{r}
# Counterfactual: Simple multiplication
baseline_density <- baseline$density
target_number <- 3

counterfactual_multiply <- get_counterfactual_density(baseline_density = baseline_density,
                                                      expected_number = target_number,
                                                      window = iraq_window,
                                                      grayscale = FALSE)

counterfactual_multiply$plot
```

# 3. Obtaining the counterfactual density by shifting locations

## 3.1. Obtaining the densities to construct a power density

```{r}
# Density 1: Distance from focuses (i.e., points)

## Data on locations
focus_locations <- cbind(longitude = 43.158, latitude = 36.349) #Mosul only
#focus_locations <- cbind(longitude = 44.025, latitude = 32.614) #Baghdad only
#focus_locations <- cbind(longitude = c(44.025, 43.158), latitude = c(32.614, 36.349)) #Baghdad and Mosul

## Distance from focuses
distance_from_focus <- get_dist_focus(focus_locations = focus_locations, 
                                      window = iraq_window)

plot(distance_from_focus)
```

```{r}
# Density 2: Distance from routes (i.e., lines)

distance_from_routes <- exp(-routes_dist)/integral(routes_dist)
plot(distance_from_routes)
```

```{r}
# Density 3: Sectarian (polygon)

sunni <- sectarian$Sunni
plot(sunni)
```

```{r}
# Density 4: Elevation
elevation_data <- get_elevation(load_path = "~/geocausal/Data/iraq_boundary_adm1/.",
                                z = 5)

elevation <- elevation_data$im
plot(elevation)
elevation_data$plot

## Convert it to terrain (slope)
#terrain_data <- raster::terrain(elevation_data, opt = "slope")
#terrain_im <- maptools_as.im.RasterLayer(terrain_data)
```

## 3.2. Obtaining power densities

```{r}
target_sunni_routes <- list(sunni, distance_from_routes)
priorities <- c(2, 2)

# Example 1: Sectarian x Routes
power_sunni_routes <- get_power_density(target_densities = target_sunni_routes, 
                                        priorities = priorities, 
                                        window = iraq_window,
                                        grayscale = FALSE)
plot(power_sunni_routes$density)
power_sunni_routes$plot
```

```{r}
# Example 2: Sectarian x City
target_sunni_mosul <- list(sunni, distance_from_focus)
power_sunni_mosul <- get_power_density(target_densities = target_sunni_mosul, 
                                       priorities = priorities, 
                                       window = iraq_window,
                                       grayscale = FALSE)

power_sunni_mosul$plot
```

```{r}
# Example 3: Roads x City
target_road_mosul <- list(distance_from_routes, distance_from_focus)
power_road_mosul <- get_power_density(target_densities = target_road_mosul, 
                                      priorities = priorities, 
                                      window = iraq_window,
                                      grayscale = FALSE)

power_road_mosul$plot
```

```{r}
# Example 4: Elevation x Sectarian
target_elevation_sunni <- list(elevation, sunni)
power_elevation_sunni <- get_power_density(target_densities = target_elevation_sunni,
                                           priorities = priorities,
                                           window = iraq_window,
                                           grayscale = FALSE)

plot(power_elevation_sunni$density)
```

## 3.3. Obtaining counterfactual densities

```{r}
counterfactual_location <- get_counterfactual_density(baseline_density = baseline_density,
                                                      expected_number = target_number,
                                                      power_density = power_road_mosul$density,
                                                      window = iraq_window,
                                                      grayscale = FALSE)

counterfactual_location$density
counterfactual_location$plot
```

# 3.4 Simulation

Simulation and visualization exercises for power density
- Suppose that we keep the distance from cities as it is with alpha = 2 and want to see how changing alpha from 1 to 5 for routes affects the power density...

```{r}
sim_power <- simulate_power_density(target_densities = list(distance_from_routes), #This must be a list element
                                    density_to_manipulate = distance_from_focus,
                                    priorities = 2,
                                    priorities_for_manipulation = c(1, 2, 3, 4, 5, 6),
                                    window = iraq_window,
                                    grayscale = FALSE)

sim_power$densities
sim_power$plot
```

Simulation for counterfactual densities

```{r}
# Simulation
sim_counter <- simulate_counterfactual_density(expected_number = target_number,
                                               baseline_density = baseline_density,
                                               power_simulation_results = sim_power,
                                               window = iraq_window,
                                               grayscale = FALSE)

sim_counter$densities
sim_counter$plot
```

Then choose which density? Use these as inputs

```{r}
get_distance_based_expectation <- function(counterfactual_simulation_results = sim_counter,
                                           entire_window = iraq_window,
                                           density_of_interest = distance_from_focus,
                                           grayscale = FALSE) {
  
  # Get the range and quantiles of standardized distances 
  distance_range <- range(`density_of_interest`$v, na.rm = TRUE)
  distance_quantiles <- quantile(distance_range, probs = seq(0, 1, by = 0.01))
  
  # Convert the distance map to windows
  distance_window <- matrix(`distance_map`$v, nrow = nrow(`density_of_interest`$v))
  distance_windows <- lapply(distance_quantiles, function(x) distance_window > x) # A list of binary matrices based on quantiles
  distance_owin <- lapply(distance_windows, function(x) {
    owin(mask = x, xrange = `entire_window`$xrange, yrange = `entire_window`$yrange)
  }) # Owin objects
  
  # Get the expectation
  partial_expectations <- lapply(distance_owin, function(x) {
    lapply(`counterfactual_simulation_results`$densities, function(y) {
          counter <- y
          spatstat.geom::Window(counter) <- x
          return(integral(counter))
    })
  })
  
  # Convert it to a dataframe
  expectation_results <- data.table::rbindlist(partial_expectations)/
    integral(`counterfactual_simulation_results`$densities[[1]]) #Row = 0 to 100%, Column = Diff value of priorities

  result_data <- data.frame(expectation = c(unlist(expectation_results)),
                            alpha = rep(`counterfactual_simulation_results`$priorities, each = 101),
                            distance = 1 - rep(seq(0, 1, by = 0.01), length(`counterfactual_simulation_results`$priorities)))
  result_data$alpha <- factor(result_data$alpha)
  
  # Plot
  expectation_plot <- ggplot(result_data) +
    ggplot2::geom_line(aes(x = distance, y = expectation, group = alpha, color = alpha)) +
    theme_bw() +
    labs(x = "Quantiles of distances from the focus", 
         y = "The proportion of expected treatment events\ncovered by the area") +
    ggplot2::scale_color_brewer(palette = "RdYlBu") +
    xlim(0, 1) + ylim(0, 1)

  # Plot for windows
  window_showcase_list <- list(distance_owin$`10%`, distance_owin$`20%`, distance_owin$`30%`,
                               distance_owin$`40%`, distance_owin$`50%`, distance_owin$`60%`,
                               distance_owin$`70%`, distance_owin$`80%`, distance_owin$`90%`)
  window_showcase <- lapply(window_showcase_list, spatstat.geom::as.polygonal)

  window_plot_list <- lapply(window_showcase, function(x) {
    gg <- ggplot() + 
      ggplot2::geom_polygon(data = fortify(as.data.frame(x)), aes(x = x, y = y), fill = "blue") +
      ggplot2::geom_path(data = fortify(as.data.frame(x)), aes(x = x, y = y), color = "blue") +
      ggplot2::geom_path(data = fortify(as.data.frame(entire_window)), aes(x = x, y = y)) +
      ggthemes::theme_map()
    return(gg)
  })

  # Color and plot
  
}


```




